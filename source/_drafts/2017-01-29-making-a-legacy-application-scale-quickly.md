---
layout: post
title: "Making a legacy application scale quickly"
date: 2016-05-06 12:23
comments: true
categories: [development]
---
At Kisura I had like many other start ups a legacy application that was built upon a prototype by developers who were trying to get things to market fast. Over time things have just been added on and not much thought has ever gone into performance.

During my time at Kisura I was trying to mirgate away from the legacy application towards new applications with proper caching, optimized queries, scalable system Architecture, etc. However while do this we still need to maintain the legacy application and handle the grow the company needs to maintain. Recently the web site was mentioned on TV for 10 seconds and this resulted in enough traffic to bring down our site. Shortly after this the company's marketing team managed to get a 8-10 minute tv segement on a large tv show. This meant that we had to make our slow legacy application scale and do this quickly.  

Considering the amount of time we had to do this in, 2 weeks or so. Putting data caching in the correct places, with removing inperformant code, etc wasn't really possible. You also can't just autoscale your way to handling TV traffic as autoscaling means you create new server instances when needed. It takes 5-10 minutes to create a new instance and TV traffic shows up nearly all at once within 5 seconds and is nearly all gone in 10. So if you're relying on autoscaling by the time the new server instances have arrived the TV traffic has gone and your application will have crashed.

So it was decided the way to handle this was to do full page caching. This is where we just cache the HTML output for the page and serve it from a high performance cache server instead of off our application servers. We also decided it would be cheaper and easier to use CloudFlare for this than running our own Varnish instances. We had a few slight issues with our application and couldn't just put CloudFlare in front of our application servers and let it do it's thing.

Firstly our homepage layout wasn't designed to be static. This meaning when you login you get sent back to the homepage and it has your name and different menu options. This meant if we cached the homepage when people logged in it would look like they hadn't logged in and they wouldn't be able to do anything. Or it would look like they were logged in as someone else. Both outcomes aren't desirable. So this mean we had to make the homepage static and have users go to a different area. Since we were under a time constraint, the approach was that we would make the homepage just be a call to the template rendering and then when people were logged in we would send them to /home which bypasses the cache which would have the code that was originally powering /. This meant whenever you went to / it looked like you weren't logged in so you would have to login again. A small inconvenice we can fix later.

Then our next issue was removing the creation of session cookies on pages that were static. The majority of the pages that users go to when they aren't logged in for Kisura are static pages. If the page creates a cookie then CloudFlare won't cache it. There were two reasons for the session cookie being created. One was we had a newsletter sign up form on the home page which used Cross Page Request Forgey Protection, and the other was because the homepage was covered as the logged in area then the security system would check to see if you were logged in. When it checked to see if you were logged in it would check the session and in Symfony when you check the session data and the session hasn't be started it starts a session.

First issue was rather simple and crude, we just removed the crsf protection from one of the forms since it was just the newsletter and we have a double confirm policy in place anyway. So worst case is someone gets one email asking if they signed up to the newsletter and since they didn't they won't click confirm and that'll be the end of it. The other form that was there was the login form. Considering the importance of security we didn't remove crsf from this form. Since the form was only shown once you clicked the login button and the browser faked the url to make it look like you were on /login when you weren't and the Javascript checked the url to see if you were on /login. We just just stopped the javascript from faking that you were on /login and actually made you goto /login which bypassed the cache.

Second issue was also rather simple once we found out where the issue was. But once we found that we just made the home page exempt from the security area in Symfony.

Once CloudFlare caching was turned on our application went from 2 request per second to 4 request per minute. With the majority being served by CloudFlare's edge servers. This meant when the TV traffic did come, our web site handled 1000 requests per second, with only 100 request per second hitting our application server. This meant instead of our web site going down like it did when we were mentioned for 10 seconds, our web site stayed up for the entire 10 minutes we were on the air. All that done within 2 working days.
